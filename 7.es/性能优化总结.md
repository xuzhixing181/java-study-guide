# 优化ES的GC来提升整体性能？

要优化ES的GC来提升整体的性能，可从如下几个方面考虑：

- 1）选择合适的JVM配置：合理设置堆内存大小，使用G1垃圾收集器等
- 2）调整ES配置：合理设置线程池数目，缓存大小等
- 3）监控和调优：定期监控GC日志，并根据日志调整配置参数



- 1）选择合适的JVM配置：

  - 合理设置堆内存大小，可使用`-Xms`和`-Xmx`参数设置最小和最大堆内存（`-Xms16g -Xmx16g`可指定16GB的堆内存）通常是分配系统内存的50%到70%给堆内存，但要确保不超过31GB

  - 多节点部署：在生产环境中，通常会部署多个ElasticSearch节点，每个节点的堆内存大小应根据硬件条件合理分配，以确保集群的性能和稳定性

  - 如果是JDK9及以上，ElasticSearch默认推荐使用JVM的G1收集器，在大多数情况可提供稳定的性能，在调整G1年轻代和老年代的比例时，可使用`-XX:NewRatio`和`-XX:MaxGCPauseMillis`

  - 如果是JDK8，或特定业务场景下需要低停顿时间的需求，可考虑使用CMS（Concurrent Mark-Sweep）垃圾收集器

    补充：在ElasticSearch5.0以前（基于JDK7或JDK8），默认的垃圾收集器为Parallel Old，在ElasticSearch5.x~6.x，随着JDK8的广泛使用，默认的垃圾收集器逐渐过渡为G1收集器，在ElasticSearch7.x及后续版本默认使用G1收集器，同时要求JDK版本为JDK11及以上（G1通过改进算法和优化参数配置，不断增强了性能和稳定性）

- 2）调整ElasticSearch配置：

  - 字段缓存：`indices.fielddata.cache.size`用于控制字段数据缓存的大小，当缓存太大时会增加垃圾收集的负担；缓存太小时，频繁的缓存命中率会降低性能
  - 缓冲池和线程池：合理设置ElasticSearch内部的缓冲池和线程池的大小，如：`thread_pool.bulk.size`、`thread_Pool.search.size`等，可有效降低系统负载，有助于垃圾收集器更高效地工作

- 3）监控和调优：

  - JVM GC日志：通过在JVM启动参数中添加`-XX:+PrintGCDetails -XX:+PrintGCDateStamps  `

    `-Xloggc:/path/to/gc.log`来开启GC日志记录，通过这些日志，我们可详细了解每次GC的停顿时间和频率，从而调整相关参数

  - ElasticSearch监控插件：使用X-Pack、ElasticSearch-HQ、Kibana等插件中的监控功能，实时观测集群健康状况和GC情况

  - 持续监控GC日志，通过监控GC日志，我们可发现潜在的性能瓶颈，并根据具体的情况进行相应调整，如：增加年轻代和老年代的大小占整体堆内存的比例等